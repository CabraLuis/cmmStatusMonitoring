---
import Layout from "../layouts/Layout.astro";
import CMMController from "./controller";
const parts = CMMController.getInstance().getParts();
---

<Layout title="Part Monitoring">
  <ul id="parts">
    {parts.map((part) => <li>{part}</li>)}
  </ul>
  <form id="new">
    <input type="text" id="part" />
    <button>Add</button>
  </form>
</Layout>

<script>
  const form = document.getElementById("new") as HTMLFormElement;
  const input = document.getElementById("part") as HTMLInputElement;
  form?.addEventListener("submit", (e) => {
    e.preventDefault();
    fetch("api/part", {
      method: "POST",
      body: JSON.stringify({ part: input?.value }),
      headers: {
        "Content-Type": "application/json",
      },
    });
    input.value = "";
  });

  const eventSource = new EventSource("/api/stream");

  eventSource.onmessage = (event) => {
    const parts = document.getElementById("parts");
    const li = document.createElement("li");
    li.innerText = JSON.parse(event.data);
    parts?.appendChild(li);
  };

  eventSource.onerror = () => {
    eventSource.close();
  };

  window.onbeforeunload = () => {
    eventSource.close();
  };
</script>
